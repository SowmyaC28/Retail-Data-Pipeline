# Retail Data Pipeline with Airflow, DBT on GCP

This project demonstrates an end-to-end data engineering pipeline using Airflow for orchestration, DBT for data transformations, Soda for data quality checks, and Metabase for dashboarding, all running on Google Cloud Platform (GCP).


## Project Overview

The pipeline processes retail invoice data, performing the following steps:

1. Load raw data from a CSV file into Google Cloud Storage
2. Ingest data into BigQuery
3. Perform initial data quality checks
4. Create dimension and fact tables using DBT
5. Conduct data quality checks on the dimensional model
6. Generate analytical reports using DBT
7. Perform final data quality checks on the reports
8. Create a dashboard in Metabase

## Architecture

![architecture](/architecture.png)

- **Data Storage**: Google Cloud Storage, BigQuery
- **Orchestration**: Apache Airflow
- **Data Transformation**: DBT (Data Build Tool)
- **Data Quality**: Soda
- **DBT-Airflow Integration**: Cosmos
- **Visualization**: Metabase

## Workflow

![DAG](/DAG.png)

## Project Tree
```
ðŸ“¦ 
â”œâ”€Â .astro
â”‚Â Â â”œâ”€Â config.yaml
â”‚Â Â â”œâ”€Â dag_integrity_exceptions.txt
â”‚Â Â â””â”€Â test_dag_integrity_default.py
â”œâ”€Â .dockerignore
â”œâ”€Â .gitignore
â”œâ”€Â Dockerfile
â”œâ”€Â README.md
â”œâ”€Â dags
â”‚Â Â â”œâ”€Â .airflowignore
â”‚Â Â â”œâ”€Â exampledag.py
â”‚Â Â â””â”€Â retail.py
â”œâ”€Â docker-compose.override.yml
â”œâ”€Â include
â”‚Â Â â”œâ”€Â dataset
â”‚Â Â â”‚Â Â â””â”€Â online_retail.csv
â”‚Â Â â”œâ”€Â dbt
â”‚Â Â â”‚Â Â â”œâ”€Â .user.yml
â”‚Â Â â”‚Â Â â”œâ”€Â cosmos_config.py
â”‚Â Â â”‚Â Â â”œâ”€Â dbt_project.yml
â”‚Â Â â”‚Â Â â”œâ”€Â models
â”‚Â Â â”‚Â Â â”‚Â Â â”œâ”€Â report
â”‚Â Â â”‚Â Â â”‚Â Â â”‚Â Â â”œâ”€Â report_customer_invoices.sql
â”‚Â Â â”‚Â Â â”‚Â Â â”‚Â Â â”œâ”€Â report_product_invoices.sql
â”‚Â Â â”‚Â Â â”‚Â Â â”‚Â Â â””â”€Â report_year_invoices.sql
â”‚Â Â â”‚Â Â â”‚Â Â â”œâ”€Â sources
â”‚Â Â â”‚Â Â â”‚Â Â â”‚Â Â â””â”€Â sources.yml
â”‚Â Â â”‚Â Â â”‚Â Â â””â”€Â transform
â”‚Â Â â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â dim_customer.sql
â”‚Â Â â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â dim_datetime.sql
â”‚Â Â â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â dim_product.sql
â”‚Â Â â”‚Â Â â”‚Â Â Â Â Â â””â”€Â fct_invoices.sql
â”‚Â Â â”‚Â Â â”œâ”€Â packages.yml
â”‚Â Â â”‚Â Â â”œâ”€Â profiles.yml
â”‚Â Â â”‚Â Â â””â”€Â target
â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â compiled
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â â””â”€Â retail
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â â””â”€Â models
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”œâ”€Â report
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_customer_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_product_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â””â”€Â report_year_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â””â”€Â transform
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_customer.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_datetime.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_product.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â””â”€Â fct_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â graph.gpickle
â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â manifest.json
â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â partial_parse.msgpack
â”‚Â Â â”‚Â Â Â Â Â â”œâ”€Â run
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â â””â”€Â retail
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â â””â”€Â models
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”œâ”€Â report
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_customer_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_product_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â”‚Â Â â””â”€Â report_year_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â â””â”€Â transform
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_customer.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_datetime.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_product.sql
â”‚Â Â â”‚Â Â Â Â Â â”‚Â Â Â Â Â Â Â Â Â Â Â â””â”€Â fct_invoices.sql
â”‚Â Â â”‚Â Â Â Â Â â””â”€Â run_results.json
â”‚Â Â â””â”€Â soda
â”‚Â Â Â Â Â â”œâ”€Â check_function.py
â”‚Â Â Â Â Â â””â”€Â checks
â”‚Â Â Â Â Â Â Â Â â”œâ”€Â reports
â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_customer_invoices.yml
â”‚Â Â Â Â Â Â Â Â â”‚Â Â â”œâ”€Â report_product_invoices.yml
â”‚Â Â Â Â Â Â Â Â â”‚Â Â â””â”€Â report_year_invoices.yml
â”‚Â Â Â Â Â Â Â Â â”œâ”€Â sources
â”‚Â Â Â Â Â Â Â Â â”‚Â Â â””â”€Â raw_invoices.yml
â”‚Â Â Â Â Â Â Â Â â””â”€Â transform
â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_customer.yml
â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_datetime.yml
â”‚Â Â Â Â Â Â Â Â Â Â Â â”œâ”€Â dim_product.yml
â”‚Â Â Â Â Â Â Â Â Â Â Â â””â”€Â fct_invoices.yml
â”œâ”€Â packages.txt
â”œâ”€Â requirements.txt
â””â”€Â tests
Â Â Â â””â”€Â dags
Â Â Â Â Â Â â””â”€Â test_dag_example.py
```
Â©generated by [Project Tree Generator](https://woochanleee.github.io/project-tree-generator)

1. **Raw Data Ingestion**
   - CSV file loaded to Google Cloud Storage
   - Data ingested into BigQuery as `raw_invoices` table

2. **Initial Data Quality Checks**
   - Schema validation
   - Column presence verification

3. **Preliminary Transformations**
   - Creation of `countries` table in BigQuery

4. **Dimensional Modeling**
   - DBT models create dimension tables (customer, product, datetime) and fact table (invoice)
   - Orchestrated using Cosmos integration with Airflow
  
     ![Dimensional Model](/dimensional_model.png)

5. **Data Quality Checks on Dimensional Model**
   - Soda framework performs checks on each table:
     - Schema validation
     - Uniqueness checks
     - Missing value checks
     - Range checks (where applicable)

6. **Analytical Reporting**
   - DBT models generate reports:
     - Total revenue by country
     - Revenue by year and month
     - Quantity of products sold

7. **Final Data Quality Checks**
   - Soda framework performs checks on report tables:
     - Range checks
     - Schema validation

8. **Dashboard Creation**
   - Connection established between BigQuery and Metabase
   - Retail analytics dashboard created in Metabase
  
     ![Image Description](/Dashboard.png)

## Technologies Used

- Apache Airflow
- DBT (Data Build Tool)
- Soda
- Cosmos
- Google Cloud Platform (GCP)
  - Google Cloud Storage
  - BigQuery
- Metabase






